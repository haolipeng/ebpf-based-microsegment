# eBPF å¾®éš”ç¦» - ç«¯åˆ°ç«¯æµ‹è¯•æ¡†æ¶å®ç°æ€»ç»“

## ğŸ“… å®Œæˆæ—¥æœŸ: 2025-11-01

## âœ… å·²å®Œæˆå·¥ä½œ

### é˜¶æ®µ 1: æµ‹è¯•åŸºç¡€è®¾æ–½ âœ…

#### 1.1 ç½‘ç»œæµ‹è¯•å·¥å…·åŒ…
**æ–‡ä»¶**: `src/agent/pkg/testutil/network.go` (431 è¡Œ)

**å®ç°åŠŸèƒ½**:
- âœ… Network Namespace ç®¡ç†
  - `NewTestNetwork()` - åˆ›å»ºéš”ç¦»çš„æµ‹è¯•ç½‘ç»œç¯å¢ƒ
  - `RunInClientNS()` / `RunInServerNS()` - åœ¨å‘½åç©ºé—´ä¸­æ‰§è¡Œå‡½æ•°
  - è‡ªåŠ¨æ¸…ç†èµ„æº

- âœ… veth pair åˆ›å»ºå’Œé…ç½®
  - è‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿä»¥å¤ªç½‘å¯¹
  - é…ç½® IP åœ°å€ (é»˜è®¤ 10.100.0.1/24 å’Œ 10.100.0.2/24)
  - è‡ªåŠ¨å¯åŠ¨æ¥å£

- âœ… æƒé™æ£€æŸ¥
  - `IsRoot()` - æ£€æŸ¥ root æƒé™
  - `HasCapability()` - æ£€æŸ¥ç‰¹å®š capability
  - `CheckE2ERequirements()` - å®Œæ•´çš„ç¯å¢ƒæ£€æŸ¥

**ç½‘ç»œæ‹“æ‰‘**:
```
[Client NS]                [Server NS]
    |                          |
veth-client  <-------->  veth-server
10.100.0.1              10.100.0.2
```

#### 1.2 æµé‡æµ‹è¯•å·¥å…·
**æ–‡ä»¶**: `src/agent/pkg/testutil/traffic.go` (340 è¡Œ)

**å®ç°åŠŸèƒ½**:
- âœ… TCP/UDP æœåŠ¡å™¨
  - `StartTCPServer()` - å¯åŠ¨ TCP echo æœåŠ¡å™¨
  - `StartUDPServer()` - å¯åŠ¨ UDP echo æœåŠ¡å™¨
  - è‡ªåŠ¨èµ„æºæ¸…ç†

- âœ… æµé‡ç”Ÿæˆ
  - `SendTCPPacket()` - å‘é€ TCP æ•°æ®å¹¶éªŒè¯ echo
  - `SendUDPPacket()` - å‘é€ UDP æ•°æ®å¹¶éªŒè¯ echo
  - `PingHost()` - ICMP ping æµ‹è¯•

- âœ… è¿é€šæ€§æµ‹è¯•
  - `TryConnect()` - æµ‹è¯• TCP å¯è¾¾æ€§
  - `TryConnectUDP()` - æµ‹è¯• UDP å¯è¾¾æ€§
  - `WaitForServer()` - ç­‰å¾…æœåŠ¡å™¨å°±ç»ª

- âœ… æ•°æ®åŒ…æ•è·
  - `CapturePackets()` - tcpdump wrapper

#### 1.3 eBPF éªŒè¯å·¥å…·
**æ–‡ä»¶**: `src/agent/pkg/testutil/ebpf.go` (246 è¡Œ)

**å®ç°åŠŸèƒ½**:
- âœ… æ•°æ®ç»“æ„å®šä¹‰
  - `FlowKey` - 5-tuple æµæ ‡è¯†
  - `SessionValue` - ä¼šè¯è·Ÿè¸ªæ•°æ®
  - `PolicyValue` - ç­–ç•¥æ•°æ®

- âœ… Map æ“ä½œ
  - `LookupSession()` - æŸ¥è¯¢ä¼šè¯
  - `LookupPolicy()` - æŸ¥è¯¢ç­–ç•¥
  - `CountSessions()` - ç»Ÿè®¡ä¼šè¯æ•°
  - `CountPolicies()` - ç»Ÿè®¡ç­–ç•¥æ•°

- âœ… ç»Ÿè®¡æ•°æ®
  - `GetStatistic()` - è¯»å–å•ä¸ªç»Ÿè®¡æŒ‡æ ‡
  - `GetAllStatistics()` - è¯»å–æ‰€æœ‰ç»Ÿè®¡æ•°æ®
  - Per-CPU æ•°æ®æ±‡æ€»

- âœ… éªŒè¯å‡½æ•°
  - `VerifyPolicyExists()` - éªŒè¯ç­–ç•¥å­˜åœ¨
  - `VerifySessionExists()` - éªŒè¯ä¼šè¯å­˜åœ¨

---

### é˜¶æ®µ 2: E2E æµ‹è¯•æ¡†æ¶ âœ…

#### 2.1 æµ‹è¯•ç¯å¢ƒç®¡ç†å™¨
**æ–‡ä»¶**: `src/agent/test/e2e/framework.go` (371 è¡Œ)

**æ ¸å¿ƒç»“æ„**: `E2ETestEnv`

**å®ç°åŠŸèƒ½**:
- âœ… å®Œæ•´ç¯å¢ƒè®¾ç½®
  - è‡ªåŠ¨åˆ›å»ºç½‘ç»œå‘½åç©ºé—´
  - åŠ è½½ eBPF ç¨‹åºåˆ° server veth
  - åˆ›å»º PolicyManager å’Œ Storage
  - è‡ªåŠ¨èµ„æºæ¸…ç†

- âœ… ç­–ç•¥ç®¡ç†è¾…åŠ©
  - `CreatePolicy()` - åˆ›å»ºç­–ç•¥
  - `DeletePolicy()` - åˆ é™¤ç­–ç•¥
  - `ListPolicies()` - åˆ—å‡ºç­–ç•¥
  - `VerifyPolicyInMap()` - éªŒè¯ eBPF map ä¸­çš„ç­–ç•¥

- âœ… æµé‡æµ‹è¯•è¾…åŠ©
  - `SendTCPTraffic()` - å‘é€ TCP æµé‡
  - `SendUDPTraffic()` - å‘é€ UDP æµé‡
  - `PingServer()` - ping æµ‹è¯•
  - `StartTCPServer()` / `StartUDPServer()` - å¯åŠ¨æœåŠ¡å™¨

- âœ… éªŒè¯è¾…åŠ©
  - `AssertTrafficAllowed()` - æ–­è¨€æµé‡å…è®¸
  - `AssertTrafficBlocked()` - æ–­è¨€æµé‡é˜»æ­¢
  - `AssertStatistic()` - æ–­è¨€ç»Ÿè®¡å€¼
  - `WaitForStatistic()` - ç­‰å¾…ç»Ÿè®¡è¾¾åˆ°é¢„æœŸå€¼

---

### é˜¶æ®µ 3: æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• âœ…

#### 3.1 ç­–ç•¥æ‰§è¡Œæµ‹è¯•
**æ–‡ä»¶**: `src/agent/test/e2e/policy_enforcement_test.go` (200+ è¡Œ)

**å®ç°çš„æµ‹è¯•ç”¨ä¾‹**:

1. âœ… **TestE2E_AllowPolicy** - ALLOW ç­–ç•¥å…è®¸æµé‡
   - åˆ›å»º ALLOW ç­–ç•¥
   - éªŒè¯ç­–ç•¥åœ¨ eBPF map ä¸­
   - å‘é€ TCP æµé‡
   - éªŒè¯æµé‡é€šè¿‡
   - æ£€æŸ¥ç»Ÿè®¡è®¡æ•°å™¨

2. âœ… **TestE2E_DenyPolicy** - DENY ç­–ç•¥é˜»æ­¢æµé‡
   - åˆ›å»º DENY ç­–ç•¥
   - éªŒè¯ç­–ç•¥åœ¨ eBPF map ä¸­
   - å°è¯•è¿æ¥
   - éªŒè¯è¿æ¥è¢«é˜»æ­¢
   - æ£€æŸ¥ denied_packets è®¡æ•°

3. âœ… **TestE2E_NoPolicy** - æ— ç­–ç•¥æ—¶çš„é»˜è®¤è¡Œä¸º
   - ä¸åˆ›å»ºä»»ä½•ç­–ç•¥
   - æµ‹è¯•æµé‡
   - è®°å½•é»˜è®¤è¡Œä¸ºï¼ˆå…è®¸æˆ–æ‹’ç»ï¼‰

4. âœ… **TestE2E_PolicyPriority** - ç­–ç•¥ä¼˜å…ˆçº§éªŒè¯
   - åˆ›å»ºä½ä¼˜å…ˆçº§ DENY ç­–ç•¥
   - åˆ›å»ºé«˜ä¼˜å…ˆçº§ ALLOW ç­–ç•¥
   - éªŒè¯é«˜ä¼˜å…ˆçº§ç­–ç•¥ç”Ÿæ•ˆ
   - æµé‡åº”è¯¥è¢«å…è®¸

---

## ğŸ“Š å®ç°ç»Ÿè®¡

### åˆ›å»ºçš„æ–‡ä»¶

| æ–‡ä»¶ | è¡Œæ•° | åŠŸèƒ½ |
|------|------|------|
| `pkg/testutil/network.go` | 431 | ç½‘ç»œå‘½åç©ºé—´ç®¡ç† |
| `pkg/testutil/traffic.go` | 340 | æµé‡ç”Ÿæˆå’Œæµ‹è¯• |
| `pkg/testutil/ebpf.go` | 246 | eBPF map éªŒè¯å·¥å…· |
| `test/e2e/framework.go` | 371 | E2E æµ‹è¯•æ¡†æ¶ |
| `test/e2e/policy_enforcement_test.go` | 200+ | ç­–ç•¥æ‰§è¡Œæµ‹è¯• |
| **æ€»è®¡** | **1,588+** | **5 ä¸ªæ–‡ä»¶** |

### æµ‹è¯•ç”¨ä¾‹ç»Ÿè®¡

| ç±»åˆ« | æµ‹è¯•æ•°é‡ | çŠ¶æ€ |
|------|---------|------|
| **ç­–ç•¥æ‰§è¡Œæµ‹è¯•** | 4 | âœ… å·²å®ç° |
| **ä¼šè¯è·Ÿè¸ªæµ‹è¯•** | 0 | â¬œ å¾…å®ç° |
| **åè®®æ”¯æŒæµ‹è¯•** | 0 | â¬œ å¾…å®ç° |
| **ç»Ÿè®¡å‡†ç¡®æ€§æµ‹è¯•** | 0 | â¬œ å¾…å®ç° |
| **è¾¹ç•Œæ¡ä»¶æµ‹è¯•** | 0 | â¬œ å¾…å®ç° |

### ä¾èµ–æ·»åŠ 

```go
github.com/vishvananda/netlink  // ç½‘ç»œæ¥å£ç®¡ç†
github.com/vishvananda/netns    // ç½‘ç»œå‘½åç©ºé—´
golang.org/x/sys/unix          // Unix ç³»ç»Ÿè°ƒç”¨
```

---

## ğŸ—ï¸ æ¡†æ¶æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         E2E Test Framework                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  E2ETestEnv                                 â”‚
â”‚  â”œâ”€ TestNetwork (testutil)                  â”‚
â”‚  â”‚   â”œâ”€ Client NS (10.100.0.1)             â”‚
â”‚  â”‚   â””â”€ Server NS (10.100.0.2)             â”‚
â”‚  â”œâ”€ DataPlane (eBPF program)                â”‚
â”‚  â”‚   â”œâ”€ TC hook on server veth             â”‚
â”‚  â”‚   â”œâ”€ policy_map                          â”‚
â”‚  â”‚   â”œâ”€ session_map                         â”‚
â”‚  â”‚   â””â”€ stats_map                           â”‚
â”‚  â”œâ”€ PolicyManager                           â”‚
â”‚  â”œâ”€ SQLite Storage                          â”‚
â”‚  â””â”€ Test Helpers                            â”‚
â”‚      â”œâ”€ Traffic generation                  â”‚
â”‚      â”œâ”€ Verification                        â”‚
â”‚      â””â”€ Assertions                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª å¦‚ä½•ä½¿ç”¨

### å‰ææ¡ä»¶

```bash
# éœ€è¦ root æƒé™æˆ–ç›¸åº”çš„ capabilities
sudo -i

# æˆ–è€…æˆäºˆ capabilities
sudo setcap cap_net_admin,cap_bpf,cap_sys_admin+eip /usr/local/go/bin/go
```

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰ E2E æµ‹è¯•
cd /home/work/ebpf-based-microsegment/src/agent
sudo go test -v ./test/e2e/...

# è¿è¡Œç‰¹å®šæµ‹è¯•
sudo go test -v ./test/e2e -run TestE2E_AllowPolicy

# è¿è¡Œæµ‹è¯•å¹¶æŸ¥çœ‹è¯¦ç»†è¾“å‡º
sudo go test -v ./test/e2e -run TestE2E_AllowPolicy -count=1
```

### ç¼–è¯‘æµ‹è¯•ï¼ˆæ— éœ€è¿è¡Œï¼‰

```bash
# æ£€æŸ¥ç¼–è¯‘é”™è¯¯
go test -c ./test/e2e -o /tmp/e2e.test
```

---

## âœ… éªŒè¯é¡¹

### å·²éªŒè¯åŠŸèƒ½

1. âœ… **ç¼–è¯‘é€šè¿‡**: æ‰€æœ‰ä»£ç æˆåŠŸç¼–è¯‘ï¼Œæ— é”™è¯¯
2. âœ… **æ¡†æ¶å®Œæ•´**: åŒ…å«ç¯å¢ƒè®¾ç½®ã€æµé‡ç”Ÿæˆã€éªŒè¯å·¥å…·
3. âœ… **æµ‹è¯•ç”¨ä¾‹**: 4 ä¸ªæ ¸å¿ƒæµ‹è¯•ç”¨ä¾‹å·²å®ç°
4. âœ… **è‡ªåŠ¨æ¸…ç†**: æ‰€æœ‰èµ„æºè‡ªåŠ¨æ¸…ç†
5. âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’ŒæŠ¥å‘Š

### æµ‹è¯•è¦†ç›–

- âœ… ALLOW ç­–ç•¥éªŒè¯
- âœ… DENY ç­–ç•¥éªŒè¯
- âœ… ç­–ç•¥ä¼˜å…ˆçº§
- âœ… eBPF map éªŒè¯
- âœ… ç»Ÿè®¡è®¡æ•°å™¨éªŒè¯
- âœ… é»˜è®¤è¡Œä¸ºæµ‹è¯•

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åŸºæœ¬çš„ ALLOW æµ‹è¯•

```go
func TestE2E_Basic(t *testing.T) {
    // åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
    env, err := NewE2ETestEnv(t)
    require.NoError(t, err)
    defer env.Cleanup()

    // å¯åŠ¨æœåŠ¡å™¨
    server, err := env.StartTCPServer(8080)
    require.NoError(t, err)
    defer server.Stop()

    // åˆ›å»º ALLOW ç­–ç•¥
    policy := &policy.Policy{
        RuleID:   100,
        SrcIP:    env.Network.GetClientIP(),
        DstIP:    env.Network.GetServerIP(),
        DstPort:  8080,
        Protocol: "tcp",
        Action:   "allow",
        Priority: 10,
    }
    err = env.CreatePolicy(policy)
    require.NoError(t, err)

    // å‘é€æµé‡
    err = env.SendTCPTraffic(8080, []byte("test"))
    assert.NoError(t, err) // æµé‡åº”è¯¥é€šè¿‡
}
```

### ç¤ºä¾‹ 2: éªŒè¯ eBPF Map

```go
// éªŒè¯ç­–ç•¥åœ¨ eBPF map ä¸­
exists, err := env.VerifyPolicyInMap(
    "10.100.0.1",
    "10.100.0.2",
    0,
    8080,
    "tcp",
)
require.NoError(t, err)
assert.True(t, exists)
```

### ç¤ºä¾‹ 3: æ£€æŸ¥ç»Ÿè®¡

```go
// å‘é€æµé‡åæ£€æŸ¥ç»Ÿè®¡
stats := env.GetStatistics()
assert.Greater(t, stats.AllowedPackets, uint64(0))
assert.Equal(t, uint64(0), stats.DeniedPackets)
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### å»ºè®®çš„æ‰©å±•ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

#### é«˜ä¼˜å…ˆçº§ (P0)

1. â¬œ **ä¼šè¯è·Ÿè¸ªæµ‹è¯•** (4-5 å°æ—¶)
   - æ–°ä¼šè¯åˆ›å»ºéªŒè¯
   - åŒå‘æµé‡ç»Ÿè®¡
   - ä¼šè¯çŠ¶æ€è½¬æ¢
   - LRU é©±é€æµ‹è¯•

2. â¬œ **åè®®æ”¯æŒæµ‹è¯•** (3-4 å°æ—¶)
   - TCP æµé‡æµ‹è¯•
   - UDP æµé‡æµ‹è¯•
   - ICMP ping æµ‹è¯•
   - åè®®é€šé…ç¬¦æµ‹è¯•

3. â¬œ **ç»Ÿè®¡å‡†ç¡®æ€§æµ‹è¯•** (2-3 å°æ—¶)
   - æ•°æ®åŒ…è®¡æ•°ç²¾åº¦
   - ä¼šè¯è®¡æ•°éªŒè¯
   - ç­–ç•¥å‘½ä¸­ç‡ç»Ÿè®¡
   - Per-CPU èšåˆæµ‹è¯•

#### ä¸­ä¼˜å…ˆçº§ (P1)

4. â¬œ **è¾¹ç•Œæ¡ä»¶æµ‹è¯•** (3-4 å°æ—¶)
   - Map å®¹é‡æµ‹è¯•
   - å¹¶å‘è¿æ¥æµ‹è¯•
   - å¼‚å¸¸æ•°æ®åŒ…å¤„ç†
   - èµ„æºè€—å°½åœºæ™¯

5. â¬œ **API å·¥ä½œæµæµ‹è¯•** (3-4 å°æ—¶)
   - é€šè¿‡ API åˆ›å»º/åˆ é™¤ç­–ç•¥
   - æŒä¹…åŒ–å’Œæ¢å¤
   - åŠ¨æ€æ›´æ–°ç­–ç•¥

#### ä½ä¼˜å…ˆçº§ (P2)

6. â¬œ **æ€§èƒ½åŸºå‡†æµ‹è¯•** (4-5 å°æ—¶)
   - å»¶è¿Ÿæµ‹é‡
   - ååé‡æµ‹è¯•
   - CPU ä½¿ç”¨ç‡
   - å†…å­˜å ç”¨

---

## ğŸ¯ æˆæœæ€»ç»“

### æŠ€æœ¯æˆå°±

1. âœ… **å®Œæ•´çš„æµ‹è¯•åŸºç¡€è®¾æ–½**
   - ç½‘ç»œå‘½åç©ºé—´ç®¡ç†
   - è™šæ‹Ÿç½‘ç»œæ¥å£
   - eBPF ç¨‹åºåŠ è½½
   - è‡ªåŠ¨åŒ–æ¸…ç†

2. âœ… **å¯é‡ç”¨çš„æµ‹è¯•å·¥å…·**
   - æµé‡ç”Ÿæˆå™¨
   - eBPF map éªŒè¯
   - ç»Ÿè®¡æ£€æŸ¥
   - æ–­è¨€è¾…åŠ©å‡½æ•°

3. âœ… **å®ç”¨çš„æµ‹è¯•ç”¨ä¾‹**
   - ç­–ç•¥æ‰§è¡ŒéªŒè¯
   - ä¼˜å…ˆçº§æµ‹è¯•
   - ç»Ÿè®¡éªŒè¯
   - ç«¯åˆ°ç«¯æµç¨‹

### é¡¹ç›®å½±å“

- **æµ‹è¯•è¦†ç›–ç‡**: æ–°å¢ E2E æµ‹è¯•ç»´åº¦
- **è´¨é‡ä¿éšœ**: èƒ½å¤Ÿå‘ç°çœŸå®ç¯å¢ƒä¸­çš„é—®é¢˜
- **CI/CD**: å¯é›†æˆåˆ°è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹
- **æ–‡æ¡£åŒ–**: æµ‹è¯•å³æ–‡æ¡£ï¼Œå±•ç¤ºç³»ç»Ÿè¡Œä¸º

### å­¦ä¹ ä»·å€¼

- âœ… Network Namespace éš”ç¦»æŠ€æœ¯
- âœ… eBPF ç¨‹åºæµ‹è¯•æ–¹æ³•
- âœ… Go æµ‹è¯•æ¡†æ¶æœ€ä½³å®è·µ
- âœ… ç³»ç»Ÿçº§é›†æˆæµ‹è¯•

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [Architecture Overview](../../docs/architecture_overview.md)
- [Build Guide](../../docs/build_guide.md)
- [Integration Testing Summary](../INTEGRATION_TESTING_SUMMARY.md)
- [Project Status](../../project_status.md)

---

**å®æ–½æ—¶é—´**: ~6 å°æ—¶
**ä»£ç è¡Œæ•°**: 1,588+ è¡Œ
**æµ‹è¯•ç”¨ä¾‹**: 4 ä¸ª
**çŠ¶æ€**: âœ… **é˜¶æ®µ 1 & 2 å®Œæˆï¼Œé˜¶æ®µ 3 éƒ¨åˆ†å®Œæˆ**

---

**æ³¨æ„**: è¦è¿è¡Œè¿™äº›æµ‹è¯•ï¼Œå¿…é¡»æœ‰ root æƒé™æˆ–ç›¸åº”çš„ Linux capabilities (CAP_NET_ADMIN, CAP_BPF)ã€‚æµ‹è¯•ä¼šè‡ªåŠ¨æ£€æŸ¥æƒé™å¹¶è·³è¿‡ä¸æ»¡è¶³æ¡ä»¶çš„æµ‹è¯•ã€‚
