# 微隔离产品 MVP 实施计划

## 项目目标

实现一款基于 eBPF + TC 的微隔离产品 MVP，对标**蔷薇灵动**和 **Illumio** 的核心功能：
- 工作负载级别的细粒度访问控制
- 基于标签的策略管理
- 流量可视化和应用依赖发现
- 自动策略生成
- 零信任架构支持

## 技术架构

```
┌─────────────────────────────────────────────────────────┐
│                    Web Console (前端)                    │
│        React + D3.js (流量拓扑可视化)                   │
└────────────────────┬────────────────────────────────────┘
                     │ REST API
┌────────────────────▼────────────────────────────────────┐
│              Control Plane (控制平面)                    │
│    Go/Python: 策略管理 + 标签管理 + 流量分析           │
│    - Policy Manager (策略CRUD)                          │
│    - Label Manager (自动打标签)                         │
│    - Flow Collector (流量收集分析)                      │
│    - Policy Generator (策略自动生成)                    │
└────────────────────┬────────────────────────────────────┘
                     │ gRPC/JSON
┌────────────────────▼────────────────────────────────────┐
│               Data Plane (数据平面)                      │
│    eBPF + TC + C/libbpf: 策略执行引擎                   │
│    - Packet Filter (5元组匹配)                          │
│    - Session Tracker (会话管理)                         │
│    - Policy Enforcer (策略执行)                         │
│    - Flow Reporter (流量上报)                           │
└─────────────────────────────────────────────────────────┘
```

## 实施阶段（8周）

### 第1-2周：数据平面核心功能（eBPF）

**目标**：完成高性能的eBPF策略执行引擎

- 会话跟踪系统（LRU_HASH）
- 5元组策略匹配（精确匹配 + 范围匹配）
- 策略执行（ALLOW/DENY/LOG）
- 流量统计和上报
- TCP状态机跟踪
- 性能优化（目标 <10μs 延迟）

**关键文件**：
- `src/bpf/microsegment.bpf.c` - eBPF数据平面
- `src/user/loader.c` - libbpf加载器
- `src/user/policy_api.c` - 策略配置接口

### 第3周：控制平面基础架构

**目标**：搭建控制平面服务，提供策略管理API

- 策略管理服务（Go/Python）
- RESTful API 设计
- 与数据平面通信机制（gRPC/Unix Socket）
- 策略持久化（SQLite/PostgreSQL）
- 配置热更新机制

**关键组件**：
- `control-plane/api/` - REST API服务
- `control-plane/policy/` - 策略管理逻辑
- `control-plane/agent/` - Agent通信模块

### 第4周：标签系统和流量收集

**目标**：实现自动标签和流量可视化基础

- 工作负载自动发现（容器/进程/VM）
- 自动打标签引擎（模仿Illumio标签模型）
  - Role（角色）：web/db/cache
  - App（应用）：app-name
  - Env（环境）：prod/staging/dev
  - Location（位置）：region/az
- 流量数据收集器
- 流量数据存储（时序数据库 InfluxDB/Prometheus）

**关键功能**：
- 基于容器元数据自动打标签（K8s labels/Docker labels）
- 基于进程信息打标签（cmdline/user/port）
- 标签驱动的策略匹配

### 第5周：流量可视化和拓扑发现

**目标**：实现应用依赖关系图（对标Illumio ADM）

- 流量拓扑图生成（基于实际通信流）
- 应用依赖关系分析
- 前端可视化界面（React + D3.js/Cytoscape.js）
- 交互式策略编辑

**可视化功能**：
- 节点：工作负载（带标签）
- 边：流量关系（协议/端口/流量大小）
- 高亮：违规流量/阻断流量
- 过滤：按标签/应用/环境筛选

### 第6周：策略自动生成

**目标**：基于观察流量自动生成策略（对标Illumio策略生成器）

- 学习模式（观察N天流量）
- 策略推荐引擎
  - 基于历史连接生成白名单
  - 检测异常连接模式
  - 生成最小权限策略
- 策略模拟（What-if分析）
- 策略版本管理

**智能功能**：
- 自动识别稳定连接模式
- 排除临时/测试流量
- 合并冗余规则

### 第7周：测试和优化

**目标**：全面测试和性能调优

- 功能测试（策略执行准确性）
- 性能测试（吞吐量/延迟/CPU开销）
- 压力测试（100k+ 并发连接）
- 兼容性测试（不同内核版本/容器运行时）
- 安全测试（绕过尝试/异常处理）

**性能目标**：
- 数据包处理延迟 < 10μs
- 支持 100,000+ 并发会话
- CPU 开销 < 5%
- 内存占用 < 500MB

### 第8周：文档和部署

**目标**：完善文档和部署方案

- 用户手册
- API 文档
- 部署指南（Docker/K8s）
- 最佳实践指南
- Demo 视频

## 核心功能矩阵

| 功能模块 | 蔷薇灵动 | Illumio | 本项目 MVP | 优先级 |
|---------|---------|---------|-----------|--------|
| 基于标签的策略 | ✓ | ✓ | ✓ | P0 |
| 5元组匹配 | ✓ | ✓ | ✓ | P0 |
| 流量可视化 | ✓ | ✓ | ✓ | P0 |
| 自动策略生成 | ✓ | ✓ | ✓ | P1 |
| 会话跟踪 | ✓ | ✓ | ✓ | P0 |
| 应用层协议识别 | ✓ | ✓ | 后期 | P2 |
| 多租户支持 | ✓ | ✓ | 后期 | P2 |
| 防篡改机制 | 部分 | ✓ | 后期 | P2 |
| 零信任集成 | ✓ | ✓ | 基础 | P1 |

## 技术选型

### 数据平面
- **eBPF + TC**: 内核级数据包处理
- **libbpf 1.x**: 现代化的eBPF加载框架
- **C语言**: eBPF程序和用户态控制程序

### 控制平面
- **Go**: API服务和策略管理（高性能、并发友好）
- **gRPC**: 控制平面与数据平面通信
- **PostgreSQL**: 策略和标签持久化
- **InfluxDB**: 时序流量数据存储

### 前端
- **React**: 前端框架
- **D3.js/Cytoscape.js**: 拓扑图可视化
- **Ant Design**: UI组件库

### 部署
- **Docker**: 容器化部署
- **Kubernetes**: 编排和管理
- **Helm**: K8s部署工具

## 差异化特性

相比蔷薇灵动和Illumio，我们的优势：

1. **开源透明**：完全开源，社区驱动
2. **轻量高效**：基于eBPF，零性能损耗
3. **云原生优先**：天然适配K8s和容器环境
4. **简单易用**：一键部署，自动发现
5. **成本优势**：无License费用

## 风险和缓解

| 风险 | 影响 | 缓解措施 |
|-----|------|---------|
| eBPF内核版本兼容性 | 高 | 要求 Kernel >= 5.10，提供兼容性检查 |
| 性能瓶颈 | 中 | 使用Per-CPU Map、LRU缓存、批量处理 |
| 复杂网络环境适配 | 中 | 分阶段支持（先容器，后VM） |
| 策略冲突处理 | 低 | 实现策略优先级和冲突检测 |

## 成功标准

**MVP 验收标准**：
1. ✅ 能在容器环境中部署并工作
2. ✅ 支持基于标签的策略管理（至少1000条规则）
3. ✅ 实时流量可视化（刷新延迟 < 5秒）
4. ✅ 自动生成策略推荐（准确率 > 90%）
5. ✅ 数据包处理延迟 < 10μs
6. ✅ Web界面可用性良好
7. ✅ 完整的API文档和用户手册

## 参考资源

- 设计文档：`design-docs/implementation/ebpf-tc-implementation.md`
- NeuVector分析：`docs/neuvector-dp-agent-communication.md`
- ZFW架构分析：`docs/zfw-architecture-analysis.md`
- 项目规范：`openspec/project.md`

## 实施进度追踪

### 已完成
- [x] 完成蔷薇灵动和Illumio产品技术调研

### 进行中
- [ ] 实现eBPF会话跟踪系统（LRU_HASH Map）

### 待完成
- [ ] 实现5元组策略匹配引擎（精确+范围匹配）
- [ ] 实现策略执行引擎（ALLOW/DENY/LOG actions）
- [ ] 实现流量统计和上报机制
- [ ] 数据平面性能优化（目标<10μs延迟）
- [ ] 搭建控制平面API服务（Go/Python）
- [ ] 实现策略管理模块（CRUD + 持久化）
- [ ] 实现控制平面与数据平面通信（gRPC）
- [ ] 实现工作负载自动发现（容器/进程）
- [ ] 实现自动打标签引擎（Role/App/Env/Location）
- [ ] 实现流量数据收集器和时序存储
- [ ] 实现流量拓扑图生成和应用依赖分析
- [ ] 开发前端可视化界面（React + D3.js）
- [ ] 实现学习模式（观察流量模式）
- [ ] 实现策略自动生成和推荐引擎
- [ ] 完成功能测试（策略执行准确性）
- [ ] 完成性能测试（延迟/吞吐量/资源消耗）
- [ ] 完成压力测试（100k+并发连接）
- [ ] 编写用户手册和API文档
- [ ] 编写部署指南（Docker/K8s）和最佳实践

